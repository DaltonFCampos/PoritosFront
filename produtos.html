<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Produtos</title>
    <style>
      body {
        display: flex;
      }

      .menu {
        width: 200px;
        background-color: #f0f0f0;
        padding: 10px;
      }

      .menu a {
        display: block;
        margin-bottom: 10px;
        text-decoration: none;
        color: #333;
        font-weight: bold;
      }

      .menu a:hover {
        color: #ff6600;
      }

      .content {
        flex-grow: 1;
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
      }

      .produto {
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px;
        margin: 10px;
        max-width: 200px;
      }

      .produto img {
        max-width: 100%;
        height: auto;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
        padding-top: 60px;
      }

      .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
      .produto-img {
        max-width: 250px;
        height: auto;
      }
    </style>
  </head>
  <body>
    <div class="menu">
      <a href="reservas.html">Reservas</a>
      <a href="produtos.html">Produtos</a>
      <a href="servicos.html">Serviços</a>
      <a href="pessoas.html">Pessoas</a>
      <a href="index.html">Sair</a>
    </div>
    <div>
      <button onclick="abrirModalNovoProduto()">Novo Produto</button>
      <div class="content" id="content"></div>
    </div>

    <div id="modalNovoProduto" class="modal">
      <div class="modal-content">
        <span class="close" onclick="fecharModalNovoProduto()">&times;</span>
        <div id="modalContentNovoProduto"></div>
      </div>
    </div>

    <div id="myModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="fecharModalProduto()">&times;</span>
        <div id="modalContent"></div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
      function criarComponenteProduto(produto) {
        var componente = document.createElement("div");
        componente.classList.add("produto");
        componente.innerHTML = `
                <img src="${produto.imagem}" alt="${produto.nome}">
                <h3>${produto.nome}</h3>
                <p>Preço: R$ ${produto.preco}</p>
                <p>Estoque: ${produto.estoque}</p>
                <button>Editar Produto</button>
            `;
        var botaoDetalhes = componente.querySelector("button");
        botaoDetalhes.addEventListener("click", function () {
          abrirModalProduto(produto);
        });
        return componente;
      }
      // Função para abrir modal de criação de novo produto
      function abrirModalNovoProduto() {
        var modal = document.getElementById("modalNovoProduto");
        var modalContentNovoProduto = document.getElementById(
          "modalContentNovoProduto"
        );

        fecharModalProduto();
        modal.style.display = "block";

        modalContentNovoProduto.innerHTML = `
          <h2>Novo Produto</h2>
          <label for="nomeNovo">Nome:</label>
          <input type="text" id="nomeNovo" required><br>

          <label for="descricaoNovo">Descrição:</label>
          <input type="text" id="descricaoNovo" required><br>

          <label for="precoNovo">Preço:</label>
          <input type="text" id="precoNovo" required><br>

          <label for="descontoNovo">Desconto:</label>
          <input type="text" id="descontoNovo"><br>

          <label for="estoqueNovo">Estoque:</label>
          <input type="number" id="estoqueNovo" required><br>

          <label for="disponivelNovo">Disponível:</label>
          <input type="checkbox" id="disponivelNovo"><br>

          <label for="imagemNovo">Imagem:</label>
          <input type="file" id="imagemNovo" accept="image/*"><br>

          <button onclick="criarNovoProduto()">Criar Produto</button>
        `;

        var span = document.getElementsByClassName("close")[0];
        span.onclick = function () {
          modal.style.display = "none";
        };
      }

      // Função para fechar modal de criação de novo produto
      function fecharModalNovoProduto() {
        var modal = document.getElementById("modalNovoProduto");
        modal.style.display = "none";
      }

      // Função para criar novo produto
      function criarNovoProduto() {
        var nome = document.getElementById("nomeNovo").value;
        var descricao = document.getElementById("descricaoNovo").value;
        var preco = document.getElementById("precoNovo").value;
        var desconto = document.getElementById("descontoNovo").value;
        var estoque = document.getElementById("estoqueNovo").value;
        var disponivel = document.getElementById("disponivelNovo").checked;
        var imagemInput = document.getElementById("imagemNovo");
        var imagem = imagemInput.files[0];

        if (desconto === "") {
          desconto = 0.0;
        }

        var formData = new FormData();
        formData.append("nome", nome);
        formData.append("descricao", descricao);
        formData.append("preco", preco);
        formData.append("desconto", desconto);
        formData.append("estoque", estoque);
        formData.append("disponivel", disponivel);
        if (imagem) {
          formData.append("imagem", imagem);
        }

        fetch("http://127.0.0.1:8000/api/produtos/", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Produto criado com sucesso:", data);
            location.reload();
          })
          .catch((error) => console.error("Erro:", error));

        fecharModalNovoProduto();
      }

      // Modal Editar pordutos
      function abrirModalProduto(produto) {
        var modal = document.getElementById("myModal");
        var modalContent = document.getElementById("modalContent");

        fecharModalNovoProduto();

        modal.style.display = "block";

        var dataCriacao = new Date(produto.data_criacao);
        var dataFormatada = `${dataCriacao.getDate()}/${
          dataCriacao.getMonth() + 1
        }/${dataCriacao.getFullYear()}`;

        modalContent.innerHTML = `
    <h2>Editar Produto</h2>
    <label for="nome">Nome:</label>
    <input type="text" id="nome" value="${produto.nome}" required><br>

    <label for="descricao">Descrição:</label>
    <input type="text" id="descricao" value="${produto.descricao}" required><br>

    <label for="preco">Preço:</label>
    <input type="text" id="preco" value="${produto.preco}" required><br>

    <label for="desconto">Desconto:</label>
    <input type="text" id="desconto" value="${produto.desconto || ""}"><br>

    <label for="estoque">Estoque:</label>
    <input type="number" id="estoque" value="${produto.estoque}" required><br>

    <label for="disponivel">Disponível:</label>
    <input type="checkbox" id="disponivel" ${
      produto.disponivel ? "checked" : ""
    }><br>

    <label for="imagem">Imagem:</label>
    <input type="file" id="imagem" accept="image/*"><br>

    <img src="${produto.imagem}" alt="${
          produto.nome
        }" style="max-width: 200px"><br>

    <button onclick="confirmarEdicao(${produto.id})">Confirmar Edição</button>
    `;

        var span = document.getElementsByClassName("close")[0];
        span.onclick = function () {
          modal.style.display = "none";
        };
      }

      function fecharModalProduto() {
        var modal = document.getElementById("myModal");
        modal.style.display = "none";
      }

      function confirmarEdicao(produtoId) {
        var nome = document.getElementById("nome").value;
        var descricao = document.getElementById("descricao").value;
        var preco = document.getElementById("preco").value;
        var desconto = document.getElementById("desconto").value;
        var estoque = document.getElementById("estoque").value;
        var disponivel = document.getElementById("disponivel").checked;
        var imagemInput = document.getElementById("imagem");
        var imagem = imagemInput.files[0];
        if (desconto === "") {
          desconto = 0.0;
        }

        if (imagem) {
          // Se um novo arquivo foi selecionado, criar um FormData para incluir a imagem
          var formData = new FormData();
          formData.append("imagem", imagem);
          formData.append("nome", nome);
          formData.append("descricao", descricao);
          formData.append("preco", preco);
          formData.append("desconto", desconto);
          formData.append("estoque", estoque);
          formData.append("disponivel", disponivel);

          fetch(`http://127.0.0.1:8000/api/produtos/${produtoId}/`, {
            method: "PATCH",
            body: formData,
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(
                  "Produto não foi modificado. Status: " + response.status
                );
              }
              return response.json();
            })
            .then((data) => {
              location.reload();
            })
            .catch((error) => {
              if (error.message.includes("400")) {
                alert("Produto não foi modificado. Verifique os dados.");
              } else {
                console.error("Erro:", error);
              }
            });
        } else {
          // Se nenhum novo arquivo foi selecionado, enviar os outros dados via JSON
          var data = {
            nome: nome,
            descricao: descricao,
            preco: preco,
            desconto: desconto,
            estoque: parseInt(estoque),
            disponivel: disponivel,
          };

          fetch(`http://127.0.0.1:8000/api/produtos/${produtoId}/`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(
                  "Produto não foi modificado. Status: " + response.status
                );
              }
              return response.json();
            })
            .then((data) => {
              location.reload();
            })
            .catch((error) => {
              if (error.message.includes("400")) {
                alert("Produto não foi modificado. Verifique os dados.");
              } else {
                console.error("Erro:", error);
              }
            });
        }

        var modal = document.getElementById("myModal");
        modal.style.display = "none";
      }

      $(document).ready(function () {
        var produtosContainer = document.getElementById("content");

        fetch("http://127.0.0.1:8000/api/produtos/")
          .then((response) => response.json())
          .then((data) => {
            data.forEach(function (produto) {
              var componente = criarComponenteProduto(produto);
              produtosContainer.appendChild(componente);
            });
          })
          .catch((error) => console.error("Erro:", error));
      });
    </script>
  </body>
</html>
